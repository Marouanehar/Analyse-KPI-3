<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueberry Intelligence V8 - Dispatch & Evolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        .sidebar { background: #0f172a; width: 280px; flex-shrink: 0; }
        .nav-link { color: #94a3b8; padding: 12px 16px; border-radius: 12px; display: flex; align-items: center; gap: 12px; font-size: 13px; transition: all 0.2s; border: none; background: transparent; width: 100%; cursor: pointer; }
        .nav-link:hover { background: #1e293b; color: white; }
        .nav-link.active { background: #2563eb; color: white; font-weight: 700; }
        .card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; padding: 24px; }
        .table-container { max-height: calc(100vh - 280px); overflow-y: auto; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen w-screen">

    <div id="importModal" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-6 overflow-y-auto">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl max-w-4xl w-full my-auto">
            <div class="text-center mb-8">
                <span class="text-5xl">ü´ê</span>
                <h2 class="text-3xl font-black text-slate-800 uppercase italic tracking-tighter mt-4">Blueberry Intelligence V8</h2>
                <p class="text-slate-400 text-sm">Syst√®me de Dispatch CGI & Analyse d'Evolution</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="p-5 border rounded-3xl bg-slate-50">
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2">P√©riode 1 (2025)</label>
                    <input type="file" id="f25" class="text-xs mb-2 block w-full">
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2">P√©riode 2 (2026)</label>
                    <input type="file" id="f26" class="text-xs block w-full">
                </div>
                <div class="p-5 border rounded-3xl bg-blue-50">
                    <label class="block text-[10px] font-black uppercase text-blue-500 mb-2">Mapping Famille / Type / Pat-Glace</label>
                    <input type="file" id="fMap" multiple class="text-xs mb-4 block w-full">
                    <label class="block text-[10px] font-black uppercase text-blue-500 mb-2">Substitution (Remplacer)</label>
                    <input type="file" id="fReplace" class="text-xs block w-full">
                </div>
                <div class="p-5 border rounded-3xl bg-orange-50 md:col-span-2">
                    <label class="block text-[10px] font-black uppercase text-orange-600 mb-2">Fichiers Dispatch / R√©partition (CGI)</label>
                    <input type="file" id="fDispatch" multiple class="text-xs block w-full">
                </div>
            </div>
            <button onclick="startProcessing()" id="btnStart" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl hover:bg-blue-700 shadow-xl uppercase text-sm tracking-widest transition">Lancer l'Analyse Consolid√©e</button>
        </div>
    </div>

    <div id="mainUI" class="hidden flex w-full h-full">
        <aside class="sidebar p-6 flex flex-col h-full">
            <div class="flex items-center gap-3 mb-10 px-2">
                <span class="text-2xl">ü´ê</span>
                <span class="text-white font-black uppercase tracking-widest text-xs">Blueberry IQ</span>
            </div>
            <nav class="flex-1 space-y-1 overflow-y-auto">
                <button onclick="nav('ov')" id="n-ov" class="nav-link active">üè† Synth√®se Globale</button>
                <button onclick="nav('fam')" id="n-fam" class="nav-link">üë®‚Äçüç≥ EVO Famille (Post-Dispatch)</button>
                <button onclick="nav('type')" id="n-type" class="nav-link">üçî EVO Type (Bar/Resto)</button>
                <button onclick="nav('pg')" id="n-pg" class="nav-link">üç¶ EVO Pat / Glace</button>
                <button onclick="nav('site')" id="n-site" class="nav-link">üìç Performance par Site</button>
                <button onclick="nav('var')" id="n-var" class="nav-link">üìä Variance Prix/Vol</button>
                <button onclick="nav('abc')" id="n-abc" class="nav-link">üíπ Pareto ABC</button>
                <button onclick="nav('tf')" id="n-tf" class="nav-link">üöÄ Top/Flop Plats</button>
                <button onclick="nav('exp')" id="n-exp" class="nav-link text-emerald-400">üíæ Export R√©sultats</button>
            </nav>
            <button onclick="location.reload()" class="mt-6 p-4 bg-slate-800 text-slate-400 text-[10px] font-black uppercase rounded-xl">üîÑ Nouveau Dossier</button>
        </aside>

        <main class="flex-1 flex flex-col min-w-0">
            <header class="h-20 bg-white border-b flex items-center justify-between px-10">
                <h2 id="pageTitle" class="font-black text-slate-800 uppercase text-sm tracking-widest">Synth√®se Globale</h2>
                <div class="flex items-center gap-4">
                    <select id="siteFilter" onchange="reCalculateUI()" class="bg-slate-100 border-none rounded-xl px-4 py-2 text-[10px] font-black uppercase text-slate-600 outline-none">
                        <option value="GLOBAL">üåè Vue Entreprise</option>
                        <option value="RABAT">üìç Rabat</option>
                        <option value="MOHAMMEDIA">üìç Mohammedia</option>
                        <option value="MEGA MALL">üìç Mega Mall</option>
                        <option value="ARRIBAT CENTER">üìç Arribat Center</option>
                        <option value="CASA">üìç Casablanca</option>
                    </select>
                </div>
            </header>

            <section id="contentArea" class="flex-1 overflow-y-auto p-10 space-y-10 custom-scroll">
                <div id="p-ov" class="page-sec space-y-8">
                    <div id="ov-kpis" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[400px]">
                        <div class="card"><canvas id="chartOvEvo"></canvas></div>
                        <div class="card"><canvas id="chartOvSites"></canvas></div>
                    </div>
                </div>

                <div id="p-fam" class="page-sec hidden space-y-6">
                    <div class="bg-blue-600 text-white p-6 rounded-3xl text-sm">
                        <b>Note Strat√©gique :</b> Les montants ci-dessous incluent le dispatching de la famille <b>CGI</b>. Le CA des menus a √©t√© ventil√© proportionnellement dans chaque cuisine.
                    </div>
                    <div class="card p-0 overflow-hidden"><table class="w-full text-left"><thead class="bg-slate-50 border-b text-[10px] font-black uppercase text-slate-400"><tr><th class="p-5">Famille</th><th class="p-5 text-right">CA 2025</th><th class="p-5 text-right">CA 2026</th><th class="p-5 text-center">Evo %</th></tr></thead><tbody id="famTable" class="text-sm"></tbody></table></div>
                </div>

                <div id="p-type" class="page-sec hidden grid grid-cols-2 gap-8">
                    <div class="card"><canvas id="chartType"></canvas></div>
                    <div id="typeStats" class="space-y-4"></div>
                </div>

                <div id="p-pg" class="page-sec hidden space-y-8">
                    <div class="card h-[450px]"><canvas id="chartPG"></canvas></div>
                </div>

                <div id="p-site" class="page-sec hidden grid grid-cols-1 md:grid-cols-2 gap-6" id="siteGrid"></div>
                
                <div id="p-var" class="page-sec hidden space-y-8">
                    <div class="card h-[500px]"><canvas id="chartVar"></canvas></div>
                </div>

                <div id="p-abc" class="page-sec hidden card p-0 overflow-hidden">
                    <table class="w-full text-left"><thead class="bg-slate-50 border-b text-[10px] font-black uppercase"><tr><th class="p-4">Classe</th><th class="p-4">Article</th><th class="p-4 text-right">CA 2026</th><th class="p-4 text-right">Cumul %</th></tr></thead><tbody id="abcTable" class="text-sm"></tbody></table>
                </div>

                <div id="p-tf" class="page-sec hidden grid grid-cols-2 gap-8">
                    <div class="space-y-4"><h4 class="font-black text-emerald-600 uppercase text-xs">üöÄ Top Croissances</h4><div id="topList" class="space-y-2"></div></div>
                    <div class="space-y-4"><h4 class="font-black text-red-600 uppercase text-xs">üîª Top D√©clins</h4><div id="flopList" class="space-y-2"></div></div>
                </div>

                <div id="p-exp" class="page-sec hidden flex flex-col items-center justify-center space-y-6 h-64">
                    <button onclick="exportFullAudit()" class="bg-emerald-600 text-white px-10 py-5 rounded-3xl font-black shadow-xl hover:bg-emerald-700 transition uppercase tracking-widest">G√©n√©rer l'Audit Consolid√© (.xlsx)</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- DATA HUB ---
        let raw25 = [], raw26 = [], mapFam = {}, mapSub = {}, dispatchRules = { yr25: {}, yr26: {} };
        let processedData = [];
        let activeCharts = [];

        // --- ENGINE ---
        async function startProcessing() {
            const btn = document.getElementById('btnStart');
            btn.innerHTML = '<div class="loader mx-auto"></div>';
            
            try {
                // 1. Chargement des r√©f√©rentiels
                const fSub = document.getElementById('fReplace').files[0];
                const subRows = await readXls(fSub);
                mapSub = {}; subRows.forEach(r => { if(r['Code article']) mapSub[r['Code article']] = r['Articles a remplacer']?.toString().toUpperCase(); });

                const fFams = document.getElementById('fMap').files;
                mapFam = {};
                for(let f of fFams) {
                    const rows = await readXls(f);
                    rows.forEach(r => { if(r['Code article']) mapFam[r['Code article']] = { fam: r['Famille'], type: r['TYPE'], pg: r['PAT/GLACE'] }; });
                }

                // 2. Chargement du Dispatching (R√©partition CGI)
                const fDisp = document.getElementById('fDispatch').files;
                for(let f of fDisp) {
                    const rows = await readXls(f);
                    const is26 = f.name.includes('2026');
                    const targetRules = is26 ? dispatchRules.yr26 : dispatchRules.yr25;
                    rows.forEach(r => {
                        const sourceFam = r['Famille Elyx'];
                        const targetFam = r['Famille Modifier'];
                        const totalDisp = parseFloat(r['Total']) || 0;
                        if(sourceFam && targetFam) {
                            if(!targetRules[sourceFam]) targetRules[sourceFam] = [];
                            targetRules[sourceFam].push({ target: targetFam, amount: totalDisp });
                        }
                    });
                }

                // 3. Chargement des Ventes
                const f25 = document.getElementById('f25').files[0];
                const f26 = document.getElementById('f26').files[0];
                raw25 = await readXls(f25);
                raw26 = await readXls(f26);

                reCalculateUI();
                document.getElementById('importModal').classList.add('hidden');
                document.getElementById('mainUI').classList.remove('hidden');

            } catch (e) {
                alert("Erreur critique : " + e.message);
                location.reload();
            }
        }

        function getSiteName(nom) {
            const n = (nom || "").toUpperCase();
            if (n.includes("MOHAMMEDIA")) return "MOHAMMEDIA";
            if (n.includes("MEGA MALL") || n.includes("MM ")) return "MEGA MALL";
            if (n.includes("ARRIBAT CENTER")) return "ARRIBAT CENTER";
            if (n.includes("CASA")) return "CASA";
            return "RABAT";
        }

        function reCalculateUI() {
            const site = document.getElementById('siteFilter').value;
            const filter = (data) => site === "GLOBAL" ? data : data.filter(r => getSiteName(r['Nom Site']) === site);
            
            const s25 = filter(raw25);
            const s26 = filter(raw26);

            const items = {};
            const process = (data, yr) => {
                data.forEach(r => {
                    const code = r['Code article'];
                    const name = mapSub[code] || (r['Nom Code article'] || "").toUpperCase();
                    const ca = parseFloat(r['CA HT']) || 0;
                    const qt = parseFloat(r['QT']) || 0;
                    const m = mapFam[code] || { fam:'AUTRES', type:'NON D√âFINI', pg:'' };
                    const isChariot = (r['Nom Site'] || "").toUpperCase().includes("CHARIOT");

                    if(!items[name]) items[name] = { name, ca25:0, qt25:0, ca26:0, qt26:0, fam: isChariot ? 'CHARIOT' : m.fam, type: m.type, pg: m.pg, isCGI: m.fam === 'CGI' };
                    items[name][yr === 25 ? 'ca25' : 'ca26'] += ca;
                    items[name][yr === 25 ? 'qt25' : 'qt26'] += qt;
                });
            };
            process(s25, 25); process(s26, 26);

            processedData = Object.values(items);
            renderAll();
        }

        function renderAll() {
            activeCharts.forEach(c => c.destroy()); activeCharts = [];
            
            // Calcul du Dispatching par Famille
            const famStats = {};
            processedData.forEach(i => {
                if(!famStats[i.fam]) famStats[i.fam] = { ca25:0, ca26:0 };
                famStats[i.fam].ca25 += i.ca25; famStats[i.fam].ca26 += i.ca26;
            });

            // Application du Dispatching CGI
            const applyDispatch = (yr) => {
                const cgiKey = "CGI";
                const cgiAmount = famStats[cgiKey] ? famStats[cgiKey][yr === 25 ? 'ca25' : 'ca26'] : 0;
                const rules = yr === 25 ? dispatchRules.yr25[cgiKey] : dispatchRules.yr26[cgiKey];
                
                if(cgiAmount > 0 && rules) {
                    const totalWeight = rules.reduce((a,b) => a + b.amount, 0);
                    rules.forEach(rule => {
                        if(!famStats[rule.target]) famStats[rule.target] = { ca25:0, ca26:0 };
                        const share = (rule.amount / totalWeight) * cgiAmount;
                        famStats[rule.target][yr === 25 ? 'ca25' : 'ca26'] += share;
                    });
                    famStats[cgiKey][yr === 25 ? 'ca25' : 'ca26'] = 0; // Vider la famille CGI apr√®s dispatch
                }
            };
            applyDispatch(25); applyDispatch(26);

            // Rendu Table Famille
            document.getElementById('famTable').innerHTML = Object.entries(famStats).filter(f => f[1].ca26 > 0 || f[1].ca25 > 0).sort((a,b)=>b[1].ca26-a[1].ca26).map(([n, d]) => {
                const e = d.ca25 > 0 ? ((d.ca26-d.ca25)/d.ca25*100) : 0;
                return `<tr><td class="p-5 font-bold uppercase text-[11px]">${n}</td><td class="p-5 text-right">${fmt(d.ca25)}</td><td class="p-5 text-right font-black text-blue-600">${fmt(d.ca26)}</td><td class="p-5 text-center font-black ${e>=0?'text-emerald-500':'text-red-500'}">${e.toFixed(1)}%</td></tr>`;
            }).join('');

            // KPIs Overview
            const tot25 = Object.values(famStats).reduce((a,b)=>a+b.ca25, 0);
            const tot26 = Object.values(famStats).reduce((a,b)=>a+b.ca26,0);
            const evo = tot25 > 0 ? ((tot26-tot25)/tot25*100) : 0;
            document.getElementById('ov-kpis').innerHTML = `<div class="card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">CA Total 2026</p><p class="text-2xl font-black">${fmt(tot26)}</p></div><div class="card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">Performance</p><p class="text-2xl font-black ${evo>=0?'text-emerald-500':'text-red-500'}">${evo.toFixed(1)}%</p></div><div class="card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">Poids CGI</p><p class="text-2xl font-black text-blue-600">DISPATCH√â</p></div><div class="card text-center"><p class="text-[10px] font-black text-slate-400 uppercase">Articles</p><p class="text-2xl font-black">${processedData.length}</p></div>`;

            // Variance
            const topVar = [...processedData].sort((a,b)=>Math.abs(b.evoAbs)-Math.abs(a.evoAbs)).slice(0, 8);
            activeCharts.push(new Chart(document.getElementById('chartVar'), { type:'bar', data: { labels: topVar.map(i=>i.name.substring(0,12)), datasets: [{label:'Effet Prix', data: topVar.map(i => { const p25 = i.qt25>0?i.ca25/i.qt25:0; const p26 = i.qt26>0?i.ca26/i.qt26:0; return (p26-p25)*i.qt26; }), backgroundColor:'#6366f1'},{label:'Effet Volume', data: topVar.map(i => { const p25 = i.qt25>0?i.ca25/i.qt25:0; return (i.qt26-i.qt25)*p25; }), backgroundColor:'#10b981'}] }, options: { maintainAspectRatio: false, scales: { x:{stacked:true}, y:{stacked:true} } } }));
        }

        // HELPERS
        async function readXls(f) { const d = await f.arrayBuffer(); const wb = XLSX.read(new Uint8Array(d), {type:'array'}); return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); }
        function fmt(n) { return Math.round(n).toLocaleString('fr-MA') + " DH"; }
        function nav(p) { document.querySelectorAll('.page-sec').forEach(el => el.classList.add('hidden')); document.getElementById('p-'+p).classList.remove('hidden'); document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active')); document.getElementById('n-'+p).classList.add('active'); document.getElementById('pageTitle').innerText = document.getElementById('n-'+p).innerText.substring(3); }
        function exportFullAudit() {
            const ws = XLSX.utils.json_to_sheet(processedData.map(i => ({ Article: i.name, Famille: i.fam, Segment: i.type, "CA 2025": i.ca25, "CA 2026": i.ca26 })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Audit");
            XLSX.writeFile(wb, "Blueberry_Audit_V8.xlsx");
        }
    </script>
</body>
</html>
