<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueberry Strategic Audit - V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .sidebar { background: #0f172a; width: 280px; flex-shrink: 0; }
        .nav-link { color: #94a3b8; padding: 12px 16px; border-radius: 12px; display: flex; align-items: center; gap: 12px; font-size: 13px; transition: all 0.2s; }
        .nav-link:hover { background: #1e293b; color: white; }
        .nav-link.active { background: #2563eb; color: white; font-weight: 700; }
        .card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; padding: 24px; }
        .kpi-val { font-size: 24px; font-weight: 800; color: #1e293b; }
        .elasticity-high { color: #ef4444; } /* Fragile */
        .elasticity-low { color: #10b981; }  /* Robuste */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex min-h-screen">

    <div id="importScreen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl max-w-2xl w-full">
            <div class="text-center mb-10">
                <div class="text-5xl mb-4">üíé</div>
                <h2 class="text-3xl font-black text-slate-900 uppercase italic">Blueberry Strategic IQ</h2>
                <p class="text-slate-500">Analyses avanc√©es de Portefeuille & √âlasticit√©</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="p-4 border rounded-2xl bg-slate-50">
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2">Ventes</label>
                    <input type="file" id="f25" class="text-xs mb-2 block">
                    <input type="file" id="f26" class="text-xs block">
                </div>
                <div class="p-4 border rounded-2xl bg-blue-50">
                    <label class="block text-[10px] font-black uppercase text-blue-400 mb-2">R√©f√©rentiels</label>
                    <input type="file" id="fMap" multiple class="text-xs mb-2 block">
                    <input type="file" id="fSub" class="text-xs block">
                </div>
            </div>
            <button onclick="bootApp()" id="btnBoot" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-700 shadow-xl uppercase tracking-widest transition">Lancer l'Audit Strat√©gique</button>
        </div>
    </div>

    <div id="mainUI" class="hidden flex w-full">
        <aside class="sidebar p-6 flex flex-col h-screen sticky top-0">
            <div class="flex items-center gap-3 mb-10">
                <span class="text-2xl">ü´ê</span>
                <span class="text-white font-black uppercase tracking-tighter">Strategic Control</span>
            </div>
            <nav class="flex-1 space-y-1">
                <button onclick="showPage('growth')" class="nav-link active w-full" id="n-growth">üìà Contribution Croissance</button>
                <button onclick="showPage('elasticity')" class="nav-link w-full" id="n-elasticity">üéØ √âlasticit√© Prix</button>
                <button onclick="showPage('innovation')" class="nav-link w-full" id="n-innovation">üÜï Churn & Innovation</button>
                <button onclick="showPage('risk')" class="nav-link w-full" id="n-risk">üõ°Ô∏è Concentration Risque</button>
                <button onclick="showPage('aup')" class="nav-link w-full" id="n-aup">üí∞ Audit des Prix (AUP)</button>
                <button onclick="showPage('anomalies')" class="nav-link w-full" id="n-anomalies">üö® Anomalies Op√©rat.</button>
            </nav>
            <button onclick="exportFullAudit()" class="mt-4 bg-emerald-600 text-white p-3 rounded-xl text-[10px] font-black uppercase">üíæ Export Budg√©taire</button>
            <button onclick="location.reload()" class="mt-2 text-slate-500 text-[10px] uppercase font-bold text-center">üîÑ Reset</button>
        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden">
            <header class="h-20 bg-white border-b flex items-center justify-between px-10">
                <h2 id="pageTitle" class="font-black text-slate-800 uppercase">Contribution √† la Croissance</h2>
                <div class="flex items-center gap-4">
                    <select id="siteSelector" onchange="refreshCalculations()" class="bg-slate-100 border-none rounded-xl px-4 py-2 text-[10px] font-black uppercase outline-none">
                        <option value="GLOBAL">üåè Entreprise</option>
                        <option value="RABAT">Rabat Centre</option>
                        <option value="MOHAMMEDIA">Mohammedia</option>
                        <option value="MEGA MALL">Mega Mall</option>
                        <option value="ARRIBAT CENTER">Arribat Center</option>
                        <option value="CASA">Casablanca</option>
                    </select>
                </div>
            </header>

            <section class="flex-1 overflow-y-auto p-10 bg-slate-50">
                
                <div id="p-growth" class="page-content space-y-8">
                    <div class="bg-white p-8 rounded-[40px] border shadow-sm h-[450px]">
                        <h3 class="text-xs font-black uppercase text-slate-400 mb-6">Top 10 Contributeurs √† la croissance globale (Points de %)</h3>
                        <canvas id="chartContribution"></canvas>
                    </div>
                    <div class="card overflow-hidden p-0">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 border-b text-[10px] font-black uppercase">
                                <tr><th class="p-4">Article</th><th class="p-4">Famille</th><th class="p-4 text-right">Evo CA</th><th class="p-4 text-right text-blue-600">Contrib. Croissance</th></tr>
                            </thead>
                            <tbody id="growthTable" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div id="p-elasticity" class="page-content hidden space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card">
                            <h3 class="font-bold text-slate-800 mb-4">L√©gende Strat√©gique</h3>
                            <div class="space-y-3 text-xs">
                                <p>üü¢ <b>In√©lastique (0 √† -1) :</b> Vous pouvez augmenter les prix, le volume r√©siste. Produit fort.</p>
                                <p>üî¥ <b>√âlastique (< -1) :</b> La hausse de prix a fait chuter lourdement le volume. Risque √©lev√©.</p>
                                <p>üîµ <b>Veblen (> 0) :</b> Paradoxe. Le prix monte et le volume monte aussi (Effet de mode).</p>
                            </div>
                        </div>
                        <div class="card bg-blue-900 text-white">
                            <p class="text-[10px] font-black uppercase text-blue-300">Article le plus sensible au prix</p>
                            <p id="topElasticity" class="text-2xl font-black mt-2">-</p>
                        </div>
                    </div>
                    <div class="card h-[500px]"><canvas id="chartElasticity"></canvas></div>
                </div>

                <div id="p-innovation" class="page-content hidden space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card border-l-8 border-emerald-500">
                            <h4 class="text-xs font-black uppercase text-slate-400 mb-4">Nouveaut√©s 2026 (CA g√©n√©r√©)</h4>
                            <div id="newList" class="space-y-2"></div>
                        </div>
                        <div class="card border-l-8 border-red-500">
                            <h4 class="text-xs font-black uppercase text-slate-400 mb-4">Ventes Perdues (Articles 2025 disparus)</h4>
                            <div id="lostList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div id="p-risk" class="page-content hidden space-y-8 text-center">
                    <div class="max-w-md mx-auto">
                        <h3 class="text-xs font-black uppercase text-slate-400 mb-6">Indice de Concentration HHI</h3>
                        <div class="card p-10">
                            <div id="hhiScore" class="text-6xl font-black mb-4">0</div>
                            <p id="hhiStatus" class="font-bold uppercase text-sm"></p>
                        </div>
                    </div>
                    <div class="card p-8 h-[400px]"><canvas id="chartHHI"></canvas></div>
                </div>

                <div id="p-aup" class="page-content hidden">
                    <div class="card overflow-hidden p-0">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-[10px] font-black uppercase">
                                <tr><th class="p-4">Famille</th><th class="p-4 text-right">Prix Moyen 2025</th><th class="p-4 text-right">Prix Moyen 2026</th><th class="p-4 text-center">Variation</th></tr>
                            </thead>
                            <tbody id="aupTable" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <script>
        let db25=[], db26=[], mapFam={}, mapSub={};
        let masterData = [];
        let activeCharts = [];

        // --- CORE LOGIC ---
        function getSiteName(nom) {
            const n = (nom || "").toUpperCase();
            if (n.includes("MOHAMMEDIA")) return "MOHAMMEDIA";
            if (n.includes("MEGA MALL") || n.includes("MM ")) return "MEGA MALL";
            if (n.includes("ARRIBAT CENTER")) return "ARRIBAT CENTER";
            if (n.includes("CASA")) return "CASA";
            return "RABAT";
        }

        async function bootApp() {
            const f25 = document.getElementById('f25').files[0];
            const f26 = document.getElementById('f26').files[0];
            const fFams = document.getElementById('fMap').files;
            const fSub = document.getElementById('fSub').files[0];

            if(!f25 || !f26 || fFams.length === 0 || !fSub) return alert("Charger tous les fichiers.");

            const [subRows, ...famLists] = await Promise.all([readXls(fSub), ...Array.from(fFams).map(f => readXls(f))]);

            mapSub = {}; subRows.forEach(r => { if(r['Code article']) mapSub[r['Code article']] = r['Articles a remplacer']?.trim().toUpperCase(); });
            mapFam = {}; famLists.flat().forEach(r => { if(r['Code article']) mapFam[r['Code article']] = r['Famille'] || 'AUTRES'; });

            const process = (data, yr) => data.map(r => ({
                name: mapSub[r['Code article']] || (r['Nom Code article'] || "").toUpperCase(),
                site: getSiteName(r['Nom Site']),
                ca: parseFloat(r['CA HT']) || 0,
                qt: parseFloat(r['QT']) || 0,
                yr: yr
            }));

            db25 = process(await readXls(f25), 2025);
            db26 = process(await readXls(f26), 2026);

            refreshCalculations();
            document.getElementById('importScreen').classList.add('hidden');
            document.getElementById('mainUI').classList.remove('hidden');
        }

        function refreshCalculations() {
            const site = document.getElementById('siteSelector').value;
            const d25 = site === "GLOBAL" ? db25 : db25.filter(r => r.site === site);
            const d26 = site === "GLOBAL" ? db26 : db26.filter(r => r.site === site);

            const artMap = {};
            const agg = (data, key) => data.forEach(r => {
                if(!artMap[r.name]) artMap[r.name] = { name:r.name, ca25:0, qt25:0, ca26:0, qt26:0 };
                artMap[r.name][key+'ca'] += r.ca; artMap[r.name][key+'qt'] += r.qt;
            });
            agg(d25, '25'); agg(d26, '26');

            const totalCA25 = d25.reduce((a,b)=>a+b.ca, 0);
            
            masterData = Object.values(artMap).map(i => {
                const p25 = i.qt25 > 0 ? i.ca25 / i.qt25 : 0;
                const p26 = i.qt26 > 0 ? i.ca26 / i.qt26 : 0;
                const dP = p25 > 0 ? (p26 - p25)/p25 : 0;
                const dQ = i.qt25 > 0 ? (i.qt26 - i.qt25)/i.qt25 : 0;
                
                return {
                    ...i,
                    fam: Object.values(db26).find(x=>x.name === i.name)?.name ? (mapFam[Object.values(db26).find(x=>x.name === i.name)?.code] || 'AUTRES') : 'AUTRES',
                    contrib: totalCA25 > 0 ? ((i.ca26 - i.ca25) / totalCA25 * 100) : 0,
                    elasticity: dP !== 0 ? (dQ / dP) : 0,
                    priceVar: dP * 100
                };
            });

            renderAll();
        }

        function renderAll() {
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            // 1. Contribution Table & Chart
            const topContrib = [...masterData].sort((a,b)=>Math.abs(b.contrib)-Math.abs(a.contrib)).slice(0, 10);
            document.getElementById('growthTable').innerHTML = topContrib.map(i => `
                <tr class="border-b">
                    <td class="p-4 font-bold text-slate-700">${i.name}</td>
                    <td class="p-4 text-xs text-slate-400">${i.fam}</td>
                    <td class="p-4 text-right">${fmt(i.ca26-i.ca25)}</td>
                    <td class="p-4 text-right font-black text-blue-600">${i.contrib.toFixed(2)} pts</td>
                </tr>`).join('');
            
            activeCharts.push(new Chart(document.getElementById('chartContribution'), {
                type: 'bar', data: { labels: topContrib.map(i=>i.name.substring(0,12)), datasets: [{ label:'Contribution (pts)', data: topContrib.map(i=>i.contrib), backgroundColor:'#3b82f6' }] }
            }));

            // 2. Elasticity Chart
            const elData = masterData.filter(i => Math.abs(i.priceVar) > 2 && Math.abs(i.elasticity) < 10);
            activeCharts.push(new Chart(document.getElementById('chartElasticity'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '√âlasticit√© Articles',
                        data: elData.map(i => ({ x: i.priceVar, y: i.elasticity })),
                        backgroundColor: '#6366f1'
                    }]
                },
                options: { scales: { x: { title: { display:true, text:'Variation Prix (%)' } }, y: { title: { display:true, text:'√âlasticit√©' } } } }
            }));

            // 3. Innovation
            const nouveaux = masterData.filter(i => i.ca25 === 0 && i.ca26 > 0).sort((a,b)=>b.ca26-a.ca26).slice(0, 10);
            const perdus = masterData.filter(i => i.ca26 === 0 && i.ca25 > 0).sort((a,b)=>b.ca25-a.ca25).slice(0, 10);
            document.getElementById('newList').innerHTML = nouveaux.map(i => `<div class="flex justify-between text-xs p-2 bg-slate-50 rounded"><span>${i.name}</span><span class="font-bold text-emerald-600">${fmt(i.ca26)}</span></div>`).join('');
            document.getElementById('lostList').innerHTML = perdus.map(i => `<div class="flex justify-between text-xs p-2 bg-slate-50 rounded"><span>${i.name}</span><span class="font-bold text-red-600">${fmt(i.ca25)}</span></div>`).join('');

            // 4. HHI
            const totalCA = masterData.reduce((a,b)=>a+b.ca26, 0);
            const hhi = masterData.reduce((a,b)=> a + Math.pow((b.ca26/totalCA)*100, 2), 0);
            document.getElementById('hhiScore').innerText = Math.round(hhi);
            document.getElementById('hhiStatus').innerText = hhi < 1500 ? "Portefeuille Diversifi√© (Sain)" : "Portefeuille Concentr√© (Risqu√©)";
            document.getElementById('hhiStatus').className = hhi < 1500 ? "text-emerald-500 font-bold" : "text-red-500 font-bold";
        }

        // HELPERS
        async function readXls(f) { const d = await f.arrayBuffer(); const wb = XLSX.read(new Uint8Array(d), {type:'array'}); return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); }
        function fmt(n) { return Math.round(n).toLocaleString('fr-MA') + " DH"; }
        function showPage(p) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('p-'+p).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            document.getElementById('n-'+p).classList.add('active');
            document.getElementById('pageTitle').innerText = document.getElementById('n-'+p).innerText.substring(3);
        }
        function exportFullAudit() {
            const ws = XLSX.utils.json_to_sheet(masterData.map(i => ({ Article: i.name, "Contrib. Croissance": i.contrib.toFixed(2), "Elasticit√©": i.elasticity.toFixed(2), "Innovation": i.ca25===0?"OUI":"NON" })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Strategic_Audit");
            XLSX.writeFile(wb, "Blueberry_Strategic_Audit_V6.xlsx");
        }
    </script>
</body>
</html>
